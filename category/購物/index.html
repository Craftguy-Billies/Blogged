<!DOCTYPE html>
                  <html lang="zh">
                  <head>
                  <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <link rel="stylesheet" href="https://www.avoir.me/related_post.css">
                      <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanstc.css">
                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"     integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
                      <style>
                          * {
                              box-sizing: border-box;
                              margin: 0;
                              padding: 0;
                              font-family: 'Noto Sans TC', sans-serif;
                              scroll-behavior: smooth;
                          }
                      </style>
                      <title>購物</title>
                    </head>
                    <body>
                    <nav>
                      <ul class = "sidebar" id = "content">
                          <li class = "xmark" onclick = hidesidebar()><a href="#"><i class="fa-solid fa-xmark"></i></a></li>
                          <div id="contain">
                              
                          </div>
                      </ul>
                      <ul id = "ts">
                          <li class = "Avoir-logo"><a href="https://www.avoir.me/">Avoir</a></li>
                          <li class = "hideOnMobile dropdown">
                              <a href="#">最新推薦</a>
                              <div class="dropdownmenu">
                                  <div class="first-box2">
              
                                  </div>
                              </div>
                          </li>
                          <li class = "menu-button" onclick = showsidebar()><a href="#"><i class="fa-solid fa-bars"></i></a></li>
                      </ul>
                  </nav>
                  <div class="recommended" id="recommended">購物       </div>
                          <div class="line"></div>
                      </div>
                      <footer>
                        <div class="footerContainer">
                            <div class="socialIcons">
                                <a href=""><i class="fa-solid fa-envelope"></i></a>
                                <a href=""><i class="fa-brands fa-instagram"></i></a>
                                <a href=""><i class="fa-brands fa-x-twitter"></i></a>
                            </div>
                            <div class="footer-nav">
                                <ul id="footerCategories">
                                    <li><a href="https://www.avoir.me">主頁</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="footer-bottom">
                            <p>Copyright &copy; 2024 by <span class="highlight">Avoir.me</span> All Rights Reserved.</p>
                        </div>
                    </footer>
                  <script>
                    function showsidebar() {
                        const sidebar = document.querySelector('.sidebar')
                        sidebar.style.display = 'flex'
                    }
                    function hidesidebar() {
                        const sidebar = document.querySelector('.sidebar')
                        sidebar.style.display = 'none'
                    }
                    
                    // Function to generate the HTML for the menu
                    function generateHTML(structure) {
                        const menu = document.querySelector('ul#ts');
                        const fragment = document.createDocumentFragment();
                    
                        Object.keys(structure).forEach(category => {
                            const li = createMenuItem(category, structure);
                            fragment.appendChild(li);
                        });
                    
                        menu.appendChild(fragment);
                    }
                    
                    // Function to create a menu item with dropdown functionality
                    function createMenuItem(category, structure) {
                        const li = document.createElement('li');
                        li.className = "hideOnMobile dropdown";
                    
                        const categoryLink = document.createElement('a');
                        categoryLink.href = `https://www.avoir.me/category/${encodeURIComponent(category)}`;
                        categoryLink.textContent = category;
                        categoryLink.target = "_blank";
                    
                        const dropdownMenu = document.createElement('div');
                        dropdownMenu.className = "dropdownmenu";
                    
                        const box1 = createSubcategoryBox(category, structure[category]);
                        const box2 = document.createElement('div');
                        box2.className = "box2";
                    
                        dropdownMenu.appendChild(box1);
                        dropdownMenu.appendChild(box2);
                        li.appendChild(categoryLink);
                        li.appendChild(dropdownMenu);
                    
                        categoryLink.addEventListener('mouseenter', () => {
                            let allPosts = [];
                            Object.keys(structure[category]).forEach(subcategory => {
                                allPosts = allPosts.concat(structure[category][subcategory].posts);
                            });
                            displayPosts(allPosts, box2); // Display all posts under this category
                        });
                    
                        return li;
                    }
                    
                    // Function to create subcategory box
                    function createSubcategoryBox(category, subcategories) {
                        const box1 = document.createElement('div');
                        box1.className = "box1";
                    
                        Object.keys(subcategories).forEach(subcategory => {
                            const subcategoryLink = document.createElement('a');
                            subcategoryLink.href = `https://www.avoir.me/category/${category}/${encodeURIComponent(subcategory)}`;
                            subcategoryLink.textContent = subcategory;
                            subcategoryLink.target = "_blank";
                    
                            subcategoryLink.addEventListener('mouseenter', () => {
                                const posts = subcategories[subcategory].posts.reverse();
                                const box2 = subcategoryLink.closest('.dropdownmenu').querySelector('.box2');
                                displayPosts(posts, box2); // Display posts for this subcategory
                            });
                    
                            box1.appendChild(subcategoryLink);
                        });
                    
                        return box1;
                    }
                    
                    // Function to display posts in the dropdown menu
                    function displayPosts(posts, container) {
                        container.innerHTML = ''; // Clear previous posts
                        const fragment = document.createDocumentFragment();
                    
                        posts.slice(0, 3).forEach(post => { // Limit to 3 posts
                            const postContainer = document.createElement('div');
                            postContainer.className = 'box2-container';
                    
                            const postImageLink = document.createElement('a');
                            postImageLink.href = post.link;
                    
                            const postImage = document.createElement('img');
                            postImage.className = 'box2-img';
                            postImage.src = post.enclosure;
                            postImage.alt = post.title;
                    
                            postImageLink.appendChild(postImage);
                    
                            const postTitleContainer = document.createElement('div');
                            postTitleContainer.className = 'box2-title';
                    
                            const postTitleLink = document.createElement('a');
                            postTitleLink.href = post.link;
                            postTitleLink.textContent = post.title;
                    
                            postTitleContainer.appendChild(postTitleLink);
                    
                            const postDateContainer = document.createElement('div');
                            postDateContainer.className = 'box2-date';
                            postDateContainer.textContent = new Date(post.pubdate).toLocaleDateString();
                    
                            postContainer.appendChild(postImageLink);
                            postContainer.appendChild(postTitleContainer);
                            postContainer.appendChild(postDateContainer);
                    
                            fragment.appendChild(postContainer);
                        });
                    
                        container.appendChild(fragment); // Append all posts at once
                    
                        // Force a reflow to trigger the transition
                        requestAnimationFrame(() => {
                            document.querySelectorAll('.box2-container').forEach(container => {
                                container.classList.add('show');
                            });
                        });
                    }
                    
                    async function loadSidebarContent(structure) {
                        try {
                            const data = structure;
                            const sidebar = document.getElementById('contain');
                    
                            for (const category in data) {
                                if (data.hasOwnProperty(category)) {
                                    // Create category li
                                    const categoryLi = document.createElement('li');
                                    categoryLi.classList.add('category-item');
                    
                                    const categoryLink = document.createElement('a');
                                    categoryLink.href = `https://www.avoir.me/category/${encodeURIComponent(category)}`;
                                    categoryLink.textContent = decodeURIComponent(category);
                                    categoryLink.classList.add('category-link');
                    
                                    // Create a toggle button
                                    const toggleButton = document.createElement('button');
                                    toggleButton.textContent = '+';
                                    toggleButton.classList.add('toggle-button');
                    
                                    // Append category link and toggle button to category li
                                    categoryLi.appendChild(categoryLink);
                                    categoryLi.appendChild(toggleButton);
                    
                                    // Append category li to sidebar
                                    sidebar.appendChild(categoryLi);
                    
                                    // Create subcategory ul (hidden initially) and append it after category li
                                    const subcategoryUl = document.createElement('ul');
                                    subcategoryUl.classList.add('subcategory-list');
                                    subcategoryUl.style.display = 'none';  // Initially hidden
                    
                                    // Loop through subcategories
                                    const subcategories = data[category];
                                    for (const subcategory in subcategories) {
                                        if (subcategories.hasOwnProperty(subcategory)) {
                                            const subcategoryLi = document.createElement('li');
                                            subcategoryLi.classList.add('subcategory-item');
                    
                                            const subcategoryLink = document.createElement('a');
                                            subcategoryLink.href = `https://www.avoir.me/category/${encodeURIComponent(category)}/${encodeURIComponent(subcategory)}`;
                                            subcategoryLink.textContent = decodeURIComponent(subcategory);
                                            subcategoryLink.classList.add('subcategory-link');
                    
                                            subcategoryLi.appendChild(subcategoryLink);
                                            subcategoryUl.appendChild(subcategoryLi);
                                        }
                                    }
                    
                                    // Append subcategory ul after the category li
                                    sidebar.appendChild(subcategoryUl);
                    
                                    // Add event listener for the toggle button
                                    toggleButton.addEventListener('click', function(event) {
                                        event.preventDefault();
                    
                                        // Slide toggle effect with smooth transition
                                        if (subcategoryUl.style.display === 'none' || subcategoryUl.style.height === '0px') {
                                            var other = document.getElementsByClassName("subcategory-list");
                                            var tgl = document.getElementsByClassName("toggle-button");
                                            for(var i=0;i<other.length;i++){
                                                if(other[i].style.display == "block"){
                                                    other[i].style.height = "0px";
                                                    other[i].addEventListener('transitionend', () => {
                                                        other[i].style.display = "none";
                                                    }, {once: true});
                                                    tgl[i].textContent = "+";
                                                }
                                            }
                                            subcategoryUl.style.display = 'block';
                                            const height = subcategoryUl.scrollHeight + 'px';
                                            subcategoryUl.style.height = height;
                                            toggleButton.textContent = '-';
                                        } else {
                                            subcategoryUl.style.height = '0px';
                                            subcategoryUl.addEventListener('transitionend', () => {
                                                subcategoryUl.style.display = 'none';
                                            }, { once: true });
                                            toggleButton.textContent = '+';
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('Error loading sidebar content:', error);
                        }
                    }
                    
                    function addFooterCategories(structure) {
                        const footerNav = document.querySelector('#footerCategories');
                        const fragment = document.createDocumentFragment();
                    
                        Object.keys(structure).forEach(category => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `https://www.avoir.me/category/${encodeURIComponent(category)}`;
                            a.textContent = category;
                    
                            li.appendChild(a);
                            fragment.appendChild(li);
                        });
                    
                        footerNav.appendChild(fragment); // Append all category links at once
                        
                        // Now, append the static links
                        const staticLinks = [
                            { href: "", text: "部落格" },
                            { href: "", text: "關於我們" },
                            { href: "", text: "聯絡我們" }
                        ];
                    
                        staticLinks.forEach(link => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = link.href;
                            a.textContent = link.text;
                    
                            li.appendChild(a);
                            footerNav.appendChild(li);
                        });
                    }
                    
                    // Function to fetch and generate the HTML content
                    async function fetchAndGenerateHTML() {
                        try {
                            const response = await fetch('https://www.avoir.me/structure.json');
                            if (!response.ok) throw new Error('Network response was not ok');
                    
                            const structure = await response.json();
                    
                            // Run tasks in parallel
                            await Promise.all([
                                generateHTML(structure),         // Generate the menu
                                loadRSS(),                       // Load latest posts
                                loadSidebarContent(structure),   // Load the blog sections
                                addFooterCategories(structure),  // Add categories to footer
                                loadRSSFeed("rss.xml")
                            ]);
                    
                            document.body.style.display = "block"; // Display the body after content is ready
                        } catch (error) {
                            console.error('There was a problem with the fetch operation:', error);
                        }
                    }
                    
                    async function loadRSS() {
                        try {
                            // Fetch the rss.xml file and await the response
                            const response = await fetch('rss.xml');
                    
                            // Check if the response is OK (status 200-299)
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                    
                            // Await the text content of the response
                            const text = await response.text();
                    
                            // Parse the XML
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(text, "application/xml");
                    
                            // Get all <item> elements and reverse the list
                            const items = Array.from(xmlDoc.getElementsByTagName('item')).reverse();
                    
                            // Prepare the HTML content
                            let content = '';
                    
                            // Iterate over the first 4 items
                            items.slice(0, 4).forEach(item => {
                                const title = item.getElementsByTagName('title')[0].textContent;
                                const link = item.getElementsByTagName('link')[0].textContent;
                                const description = item.getElementsByTagName('description')[0].textContent;
                                const enclosure = item.getElementsByTagName('enclosure')[0];
                                const imgUrl = enclosure ? enclosure.getAttribute('url') : '';
                                const imgAlt = `Image related to ${title}`;  // A more descriptive alt text
                    
                                // Generate formatted date
                                const pubDate = new Date(item.getElementsByTagName('pubDate')[0].textContent).toLocaleDateString('en-HK', {
                                    year: 'numeric',
                                    month: 'numeric',
                                    day: 'numeric',
                                    timeZone: 'Asia/Hong_Kong'
                                });
                    
                                // Append the content
                                content += `
                                    <div class="box2-container show">
                                        <a href="${link}">
                                            <img class="box2-img" src="${imgUrl}" alt="${imgAlt}" loading="lazy" width="400" height="300">  <!-- Added height for aspect ratio -->
                                        </a>
                                        <div class="box2-title">
                                            <a href="${link}">${title}</a>
                                        </div>
                                        <div class="box2-date">${pubDate}</div>
                                    </div>
                                `;
                            });
                    
                            // Insert the content into the first-box element
                            document.querySelector('.first-box2').innerHTML = content;
                    
                        } catch (error) {
                            console.error('Error loading or parsing the RSS feed:', error);
                        }
                    }
                    
                    // Function to format the date
                        function formatDate(pubDate) {
                            if (!pubDate) return "";
                            
                            const date = new Date(pubDate);
                            const options = {
                                year: 'numeric',
                                month: 'numeric',
                                day: 'numeric',
                                timeZone: 'Asia/Hong_Kong'
                            };
                            
                            // Convert the date into the required format
                            const formattedDate = date.toLocaleString('en-GB', options)
                                .replace(',', '') // Remove the comma between date and time
                                .replace(/\b0(?=\d)/g, ''); // Remove leading zeros
                            
                            return formattedDate;
                        }
                    
                        function loadRSSFeed(url) {
                        // Get the src of the first <img> tag in the current article
                        const currentImgSrc = document.querySelector('img.banner')?.src || "";
                    
                        fetch(url)
                            .then(response => response.text())
                            .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                            .then(data => {
                                const items = Array.from(data.querySelectorAll("item")).reverse();
                                let html = `
                                    <div class="recommended">
                                        <div class="direct"><a href="https://www.avoir.me">Home</a> <i class="fa-solid fa-angle-right"></i> <a href="">Blog</a></div>
                                        <div class="recommend">主題</div>
                                        <div class="line"></div>
                                `;
                    
                                items.forEach(el => {
                                    // Safely access each element
                                    const title = el.querySelector("title")?.textContent || "No title available";
                                    const link = el.querySelector("link")?.textContent || "#";
                                    let description = el.querySelector("description")?.textContent || "No description available";
                                    const pubdate = el.querySelector("pubDate")?.textContent || "";
                                    const enclosure = el.querySelector("enclosure")?.getAttribute("url") || "";
                    
                                    // Truncate description to 60 characters and add "..."
                                    if (description.length > 60) {
                                        description = description.substring(0, 60) + "...";
                                    }
                    
                                    // Skip this item if the current article's first img src matches the link
                                    if (currentImgSrc === link) {
                                        return; // Skip this post
                                    }
                    
                                    // Check if pubdate exists and format it if available
                                    let formattedDate = "";
                                    if (pubdate) {
                                        formattedDate = formatDate(pubdate);
                                    }
                    
                                    html += `
                                        <div class="recommend-row">
                                            <div class="recommend-blog-title-page">
                                                <div class="recommend-blog-title">
                                                    <a href="${link}" class="nostyle" target="_blank">${title}</a>
                                                </div>
                                                <div class="recommend-blog-description">
                                                    ${description}
                                                </div>
                                                <div class="recommend-blog-date">
                                                    ${formattedDate}
                                                </div>
                                            </div>
                                            ${enclosure ? `<a href="${link}" class="nostyle" target="_blank"><img class="recommend-blog-img-edit" src="${enclosure}" alt="${title}"/></a>` : ""}
                                        </div>
                                    `;
                                });
                    
                                html += `</div>`; // Close the recommended div
                                document.getElementById('recommended').innerHTML += html;
                            })
                            .catch(error => {
                                console.error('Error fetching or parsing RSS feed:', error);
                                document.getElementById('recommended').innerHTML = '';
                            });
                    }
                    
                    window.onload = fetchAndGenerateHTML;
                  </script>
                  </body>
                  </html>
                  